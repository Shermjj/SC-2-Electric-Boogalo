---
title: "Notes"
output:
  pdf_document: default
urlcolor: blue
date: "2024-05-15"
header-includes: 
  - \DeclareMathOperator*{\argmin}{arg\,min}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=12, fig.height=10)
```

```{r}
# devtools::install_github("mfasiolo/electBook")
library(electBook)
data(Irish)

summary(Irish$survey)
print("--------------------------------------")
print("--------------------------------------")
print("--------------------------------------")
summary(Irish$extra)
```

# Gaussian Process Regression

Gaussian process regression seems like a good fit for our noisy data, especially since we will have a distribution of possible `demand` points for each `dateTime`, corresponding to the uncertainty in our predictions.

## Theory

A gaussian process is a collection of random variables, which have a joint Gaussian distribution. A Gaussian process is completely specified by its mean function and covariance function. We build the following model:

Let $y_i = f(x_i) + \varepsilon_i$, where $f(x) \sim \text{GP}(0, k(x, x'))$ and $\varepsilon_i \sim N(0, \sigma^2)$. Then we can find the posterior distribution of $f(x_*)$ given $y$ as:

$$
f(x_*) | y \sim N(\mu(x_*), \sigma^2(x_*))
$$

where $\mu(x_*) = k(x_*, x)^T(K + \sigma^2I)^{-1}y$ and $\sigma^2(x_*) = k(x_*, x_*) - k(x_*, x)^T(K + \sigma^2I)^{-1}k(x_*, x)$. In pratice, to find the posterior distribution, we maximise the marginal log-likelihood.

## Implementation

```{r}
#Plotting two different households agains eachother over a week
library(kernlab)
library(tidyverse)

set.seed(123)

# Data cleaning
# Sample a subset of households for plotting
house_sample <- sample(colnames(Irish$indCons), 2)

irish_demand_sample <- Irish$indCons[,house_sample] %>%
  bind_cols(Irish$extra) %>% # add time-related variables
  pivot_longer(cols = all_of(house_sample), names_to = "house_sample", values_to = "demand") %>%
  # Data cleaning
  select(-time, -holy) %>% 
  # Feature engineering
  mutate(
    hour = hour(dateTime),
    month = month(dateTime),
    weekend = ifelse(dow %in% c("Sat", "Sun"), 1, 0)
  ) %>% 
  mutate(temp_sq = temp^2) %>%  # quadratic term for temperature
  # One-hot encode the day of the week
  bind_cols(model.matrix(~ dow - 1, data = .)) %>% 
  select(-dow)


irish_demand_train <- irish_demand_sample %>% 
  filter(dateTime < "2010-12-01")

irish_demand_test <- irish_demand_sample %>%
  filter(dateTime >= "2010-12-01")

house1 <-  filter(irish_demand_sample,house_sample == house_sample[1] & dateTime >= "2010-12-01" & dateTime < "2010-12-08")
house2 <-  filter(irish_demand_sample,house_sample == house_sample[2] & dateTime >= "2010-12-01" & dateTime < "2010-12-08")

ggplot()+
  geom_point(data = house1, aes(x = dateTime, y = demand),color = "#cc00ff")+
  geom_point(data = house2, aes(x = dateTime, y = demand),color = "#004550")+
  labs(title = "Electricity demand vs temperature for two sample households",
       x = "Temperature", y = "Electricity demand (kWh)")
```

```{r,include = FALSE}
# Plot the distribution of demand at 5 random times

# Step 1: Select 5 random times
random_times <- sample(unique(irish_demand_sample$dateTime), 3)

# Step 2: Filter the data
data_random_times <- irish_demand_sample %>% 
  filter(dateTime %in% random_times)

# Step 3: Create the histogram
ggplot(data_random_times, aes(x = demand)) +
  geom_histogram(binwidth = 0.5) +
  facet_wrap(~ dateTime, scales = "free_x") +
  labs(title = "Distribution of demand at 5 random times",
       x = "Demand", y = "Count")

```

```{r}
library(kernlab)
library(dyplr)
# Step 2: Define your training data
x <- as.vector(house1$dateTime)
y <- as.vector(house1$demand)

# Step 3: Fit the Gaussian process model
# Use a Radial Basis Function (RBF) kernel
gpr_model <- gausspr(x, y, kernel = "rbfdot")

# Step 4: Predict the demand for the test dataset
# (replace `irish_demand_test$dateTime` with your actual test data)
prediction_data <- data.frame(
  prediction = predict(gpr_model, as.vector(irish_demand_test$dateTime))
)

house1_with_predictions <- left_join(house1, prediction_data, by = "dateTime")

ggplot(house1_with_predictions, aes(x = dateTime)) +
  geom_point(aes(y = prediction), color = "blue") +
  geom_line(aes(y = prediction), color = "red") +
  labs(title = "GPR model predictions",
       x = "Date", y = "Predicted demand")

print(predictions)
```

